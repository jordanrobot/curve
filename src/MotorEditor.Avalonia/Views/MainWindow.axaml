<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:CurveEditor.ViewModels"
        xmlns:views="using:CurveEditor.Views"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="CurveEditor.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="{Binding WindowTitle}"
        Width="1200" Height="800"
        MinWidth="800" MinHeight="600">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>
    
    <!-- Keyboard Shortcuts -->
    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewMotorCommand}"/>
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenFileCommand}"/>
        <KeyBinding Gesture="Ctrl+W" Command="{Binding CloseFileCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}"/>
        <KeyBinding Gesture="Ctrl+Shift+S" Command="{Binding SaveAsCommand}"/>
        <KeyBinding Gesture="Ctrl+Z" Command="{Binding UndoCommand}"/>
        <KeyBinding Gesture="Ctrl+Y" Command="{Binding RedoCommand}"/>
        <KeyBinding Gesture="Ctrl+B" Command="{Binding ToggleBrowserPanelCommand}"/>
        <KeyBinding Gesture="Ctrl+R" Command="{Binding TogglePropertiesPanelCommand}"/>
        <KeyBinding Gesture="Ctrl+G" Command="{Binding ToggleCurveDataPanelCommand}"/>

        <KeyBinding Gesture="F5" Command="{Binding DirectoryBrowser.RefreshCommand}"/>

        <KeyBinding Gesture="Ctrl+Add" Command="{Binding DirectoryBrowser.IncreaseFontSizeCommand}"/>
        <KeyBinding Gesture="Ctrl+OemPlus" Command="{Binding DirectoryBrowser.IncreaseFontSizeCommand}"/>
        <KeyBinding Gesture="Ctrl+Subtract" Command="{Binding DirectoryBrowser.DecreaseFontSizeCommand}"/>
        <KeyBinding Gesture="Ctrl+OemMinus" Command="{Binding DirectoryBrowser.DecreaseFontSizeCommand}"/>
    </Window.KeyBindings>
    
    <Window.Styles>
        <!-- Panel Header Style -->
        <Style Selector="TextBlock.PanelHeader">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Foreground" Value="{DynamicResource CurveEditor.SideBar.SectionHeader.ForegroundBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style Selector="Border.PanelHeaderContainer">
            <Setter Property="Background" Value="{DynamicResource CurveEditor.SideBar.SectionHeader.BackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource CurveEditor.SideBar.BorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>
        
        <!-- Collapsible Header Style -->
        <Style Selector="ToggleButton.CollapsibleHeader">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundBaseLowBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        
        <!-- Property Label Style -->
        <Style Selector="TextBlock.PropertyLabel">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Foreground" Value="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <Setter Property="Margin" Value="0,0,4,0"/>
            <Setter Property="MinWidth" Value="85"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <!-- Property Value Style -->
        <Style Selector="TextBlock.PropertyValue">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <!-- Property Input Style -->
        <Style Selector="TextBox.PropertyInput">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
        </Style>
        
        <!-- Property ComboBox Style -->
        <Style Selector="ComboBox.PropertyComboBox">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>
        
        <!-- Property Row Style -->
        <Style Selector="Grid.PropertyRow">
            <Setter Property="Margin" Value="0,1"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
        </Style>
        
        <!-- GridSplitter Style -->
        <Style Selector="GridSplitter">
            <Setter Property="Background" Value="{DynamicResource CurveEditor.Splitter.Brush}"/>
        </Style>
    </Window.Styles>

    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_New" Command="{Binding NewMotorCommand}" InputGesture="Ctrl+N"/>
                <MenuItem Header="_Open..." Command="{Binding OpenFileCommand}" InputGesture="Ctrl+O"/>
                <MenuItem Header="_Close" Command="{Binding CloseFileCommand}" InputGesture="Ctrl+W"/>
                <MenuItem Header="Open _Folder..." Command="{Binding OpenFolderCommand}"/>
                <MenuItem Header="Close _Folder" Command="{Binding DirectoryBrowser.CloseFolderCommand}"/>
                <Separator/>
                <MenuItem Header="_Save" Command="{Binding SaveCommand}" InputGesture="Ctrl+S"/>
                <MenuItem Header="Save _As..." Command="{Binding SaveAsCommand}" InputGesture="Ctrl+Shift+S"/>
                <MenuItem Header="Save Copy As..." Command="{Binding SaveCopyAsCommand}"/>
                <Separator/>
                <MenuItem Header="E_xit" Command="{Binding ExitCommand}" InputGesture="Alt+F4"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo"
                          Command="{Binding UndoCommand}"
                          IsEnabled="{Binding CanUndo}"
                          InputGesture="Ctrl+Z"/>
                <MenuItem Header="_Redo"
                          Command="{Binding RedoCommand}"
                          IsEnabled="{Binding CanRedo}"
                          InputGesture="Ctrl+Y"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="Show _Directory Browser"
                          IsChecked="{Binding IsBrowserPanelExpanded}"
                          Command="{Binding ToggleBrowserPanelCommand}"
                          InputGesture="Ctrl+B"/>
                <MenuItem Header="Show _Properties Panel"
                          IsChecked="{Binding IsPropertiesPanelExpanded}"
                          Command="{Binding TogglePropertiesPanelCommand}"
                          InputGesture="Ctrl+R"/>
                <MenuItem Header="Show _Curve Data Panel"
                          IsChecked="{Binding IsCurveDataExpanded}"
                          Command="{Binding ToggleCurveDataPanelCommand}"
                          InputGesture="Ctrl+G"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="Open _Logs Folder" Command="{Binding OpenLogsFolderCommand}"/>
                <Separator/>
                <MenuItem Header="_About" IsEnabled="False"/>
            </MenuItem>
        </Menu>

        <!-- No top toolbar: Close Folder is File menu only (Phase 3.1). -->

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" 
                Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                Padding="8,4">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Grid.Column="0"
                           Text="{Binding StatusMessage}" 
                           FontSize="12"
                           VerticalAlignment="Center"/>
                <!-- Validation Error Indicator -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="4"
                            IsVisible="{Binding HasValidationErrors}">
                    <TextBlock Text="⚠️"
                               FontSize="12"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="Validation errors"
                               Foreground="Orange"
                               FontSize="12"
                               VerticalAlignment="Center"
                               ToolTip.Tip="{Binding ValidationErrors}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area with Panel Bar and resizable panels -->
        <Grid x:Name="RootLayoutGrid" ColumnDefinitions="Auto,*,Auto">
            
            <!-- Panel Bar (docked left or right based on PanelBarDockSide) -->
            <views:PanelBar Grid.Column="0" 
                            x:Name="PanelBarControl"
                            DockSide="{Binding PanelBarDockSide}"/>
            
            <!-- Main Layout Grid with all panels -->
            <Grid x:Name="MainLayoutGrid" 
                  Grid.Column="1"
                  ColumnDefinitions="200,4,*,4,280">
            
            <!-- Left Zone: Browser and Data panels (zone exclusivity: only one visible at a time) -->
            <Grid Grid.Column="0" RowDefinitions="*">
                <!-- Browser Panel -->
                <Border Grid.Row="0"
                        IsVisible="{Binding IsBrowserPanelExpanded}"
                        Background="{DynamicResource CurveEditor.SideBar.BackgroundBrush}"
                        BorderBrush="{DynamicResource CurveEditor.SideBar.BorderBrush}"
                        BorderThickness="0,0,1,0"
                        Padding="0">
                    <Grid RowDefinitions="Auto,*">
                        <Border Grid.Row="0" Classes="PanelHeaderContainer">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <TextBlock Grid.Column="0"
                                           Text="Directory Browser"
                                           Classes="PanelHeader"/>

                                <Button Grid.Column="1"
                                        Content="↻"
                                        ToolTip.Tip="Refresh Explorer"
                                        Command="{Binding DirectoryBrowser.RefreshCommand}"
                                        IsEnabled="{Binding DirectoryBrowser.RootDirectoryPath, Converter={x:Static ObjectConverters.IsNotNull}}"
                                        Padding="6,2"
                                        VerticalAlignment="Center"/>
                            </Grid>
                        </Border>

                        <views:DirectoryBrowserPanel Grid.Row="1" DataContext="{Binding DirectoryBrowser}"/>
                    </Grid>
                </Border>
                
                <!-- Data Panel -->
                <Border Grid.Row="0"
                        IsVisible="{Binding IsCurveDataExpanded}"
                        Background="{DynamicResource CurveEditor.SideBar.BackgroundBrush}"
                        BorderBrush="{DynamicResource CurveEditor.SideBar.BorderBrush}"
                        BorderThickness="0,0,1,0"
                        Padding="0"
                        IsEnabled="{Binding CurrentMotor, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Grid RowDefinitions="Auto,*">
                        <Border Grid.Row="0" Classes="PanelHeaderContainer">
                            <TextBlock Text="Curve Data"
                                       Classes="PanelHeader"/>
                        </Border>
                        <ScrollViewer Grid.Row="1" Margin="8">
                            <views:CurveDataPanel DataContext="{Binding}"/>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Grid>
            
            <!-- Left GridSplitter -->
            <GridSplitter x:Name="LeftSplitter" Grid.Column="1" Width="4" ResizeDirection="Columns"/>

            <!-- Center: Chart Area -->
            <Grid x:Name="CenterGrid" Grid.Column="2">
                <!-- Chart Area -->
                <Border Margin="4"
                    Background="{DynamicResource CurveEditor.Editor.BackgroundBrush}"
                    BorderBrush="{DynamicResource CurveEditor.Editor.BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4">
                    <Grid>
                        <!-- Welcome screen when no motor loaded -->
                        <StackPanel VerticalAlignment="Center" 
                                    HorizontalAlignment="Center"
                                    IsVisible="{Binding CurrentMotor, Converter={x:Static ObjectConverters.IsNull}}">
                            <TextBlock Text="Motor Torque Curve Editor" 
                                       FontSize="24" 
                                       FontWeight="Bold"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="Create a new motor definition or open an existing file to get started."
                                       Margin="0,16,0,0"
                                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                       HorizontalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" 
                                        HorizontalAlignment="Center" 
                                        Margin="0,24,0,0"
                                        Spacing="16">
                                <Button Content="New Motor" 
                                        Command="{Binding NewMotorCommand}"
                                        Padding="16,8"/>
                                <Button Content="Open File" 
                                        Command="{Binding OpenFileCommand}"
                                        Padding="16,8"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Chart when motor is loaded -->
                        <views:ChartView DataContext="{Binding ChartViewModel}"
                                         IsVisible="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).CurrentMotor, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                    </Grid>
                </Border>
            </Grid>
            
            <!-- Right GridSplitter -->
            <GridSplitter x:Name="RightSplitter" Grid.Column="3" Width="4" ResizeDirection="Columns"/>

            <!-- Right: Motor Properties Panel -->
            <views:MotorPropertiesPanel Grid.Column="4"/>
        </Grid>
        
        </Grid> <!-- Close RootLayoutGrid -->
    </DockPanel>

</Window>
