<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CurveEditor.ViewModels"
             xmlns:models="using:JordanRobot.MotorDefinition.Model"
             mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="400"
             x:Class="CurveEditor.Views.CurveDataPanel"
             x:DataType="vm:MainWindowViewModel">
    
    <UserControl.Styles>
        <!-- Cell style -->
        <Style Selector="TextBox.Cell">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="MinHeight" Value="24"/>
            <Setter Property="MinWidth" Value="60"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="TextBox.Cell:focus">
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="BorderBrush" Value="White"/>
        </Style>
        <Style Selector="TextBlock.Cell">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style Selector="TextBlock.Header">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <!-- Selected cell container style -->
        <Style Selector="Border.CellContainer">
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Border.CellContainer.Selected">
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="BorderBrush" Value="White"/>
            <Setter Property="Background" Value="#33FFFFFF"/>
        </Style>
        <!-- DataGrid row selection override for cell-level selection -->
        <Style Selector="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="DataGridRow:selected">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="DataGridRow:selected /template/ Rectangle#BackgroundRectangle">
            <Setter Property="Fill" Value="Transparent"/>
        </Style>
    </UserControl.Styles>
    
    <Grid RowDefinitions="Auto,*">
        <!-- Header Row -->
        <Border Grid.Row="0" 
                BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}"
                BorderThickness="0,0,0,1"
                IsVisible="{Binding SelectedVoltage, Converter={x:Static ObjectConverters.IsNotNull}}">
            <ScrollViewer x:Name="HeaderScrollViewer" 
                          HorizontalScrollBarVisibility="Hidden"
                          VerticalScrollBarVisibility="Disabled">
                <StackPanel Orientation="Horizontal">
                    <!-- Fixed columns: % and RPM -->
                    <Border Width="50" BorderThickness="0,0,1,0" 
                            BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}">
                        <TextBlock Text="%" Classes="Header" HorizontalAlignment="Center"/>
                    </Border>
                    <Border Width="70" BorderThickness="0,0,1,0" 
                            BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}">
                        <TextBlock Text="RPM" Classes="Header" HorizontalAlignment="Center"/>
                    </Border>
                    
                    <!-- Dynamic series columns -->
                    <ItemsControl ItemsSource="{Binding AvailableSeries}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:Curve">
                                <Border Width="80" BorderThickness="0,0,1,0" 
                                        BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}">
                                    <StackPanel Margin="2,2">
                                        <!-- Series Name (double-click to rename) -->
                                        <TextBlock Text="{Binding Name}" 
                                                   Classes="Header" 
                                                   HorizontalAlignment="Center"
                                                   Cursor="Hand"
                                                   DoubleTapped="OnSeriesNameDoubleTapped"/>
                                        <!-- Controls row -->
                                        <StackPanel Orientation="Horizontal" 
                                                    HorizontalAlignment="Center"
                                                    Spacing="4">
                                            <!-- Visibility checkbox -->
                                            <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay}"
                                                      ToolTip.Tip="Toggle Visibility"
                                                      Click="OnSeriesVisibilityCheckboxClick"
                                                      Padding="0"
                                                      MinWidth="0"/>
                                            <!-- Lock button -->
                                            <ToggleButton IsChecked="{Binding Locked, Mode=OneWay}"
                                                          Width="20" Height="20"
                                                          Padding="0"
                                                          ToolTip.Tip="Toggle Lock"
                                                          Click="OnSeriesLockToggleClick">
                                                <Panel>
                                                    <TextBlock Text="ðŸ”’" FontSize="10" IsVisible="{Binding Locked}"/>
                                                    <TextBlock Text="ðŸ”“" FontSize="10" IsVisible="{Binding !Locked}"/>
                                                </Panel>
                                            </ToggleButton>
                                            <!-- Trash button (in header) - disabled when locked -->
                                            <Button Width="20" Height="20"
                                                    Padding="0"
                                                    ToolTip.Tip="Delete Series"
                                                    Click="OnDeleteSeriesClick"
                                                    IsEnabled="{Binding !Locked}">
                                                <TextBlock Text="ðŸ—‘" FontSize="10"/>
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Add Series button in header -->
                    <Button Width="30" Height="30"
                            Padding="0"
                            Margin="4,0"
                            VerticalAlignment="Center"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            ToolTip.Tip="Add new curve series"
                            Command="{Binding AddSeriesCommand}">
                        <TextBlock Text="+" FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                </StackPanel>
            </ScrollViewer>
        </Border>
        
        <!-- Data Grid for rows -->
        <DataGrid Grid.Row="1"
                  x:Name="DataTable"
                  ItemsSource="{Binding CurveDataTableViewModel.Rows}"
                  AutoGenerateColumns="False"
                  CanUserReorderColumns="False"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="False"
                  IsReadOnly="False"
                  GridLinesVisibility="Horizontal"
                  HeadersVisibility="None"
                  SelectionMode="Single"
                  IsVisible="{Binding SelectedVoltage, Converter={x:Static ObjectConverters.IsNotNull}}"
                  CellEditEnded="DataGrid_CellEditEnded">
            <DataGrid.Columns>
                <DataGridTextColumn Header="%" 
                                    Binding="{Binding Percent}" 
                                    Width="50"
                                    IsReadOnly="True"/>
                <DataGridTextColumn Header="RPM" 
                                    Binding="{Binding DisplayRpm}" 
                                    Width="70"
                                    IsReadOnly="True"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Empty state -->
        <StackPanel Grid.Row="0" Grid.RowSpan="2"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    IsVisible="{Binding SelectedVoltage, Converter={x:Static ObjectConverters.IsNull}}">
            <TextBlock Text="No voltage configuration selected"
                       Foreground="Gray"
                       FontStyle="Italic"
                       HorizontalAlignment="Center"/>
            <TextBlock Text="Select a drive and voltage to view curve data"
                       Foreground="Gray"
                       FontSize="11"
                       HorizontalAlignment="Center"
                       Margin="0,4,0,0"/>
        </StackPanel>
    </Grid>
</UserControl>
