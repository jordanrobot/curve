<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:CurveEditor.ViewModels"
             xmlns:conv="using:CurveEditor.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="280" d:DesignHeight="600"
             x:Class="CurveEditor.Views.DirectoryBrowserPanel"
             x:DataType="vm:DirectoryBrowserViewModel">

    <UserControl.Resources>
        <conv:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

        <!-- Fluent chevrons (from requirement SVGs), expressed as PathGeometry. -->
        <PathGeometry x:Key="CurveEditor.DirectoryBrowser.ChevronRightGeometry">M8.293,4.293 C8.684,3.902 9.317,3.902 9.707,4.293 L16.707,11.293 C17.098,11.684 17.098,12.317 16.707,12.707 L9.707,19.707 C9.317,20.098 8.684,20.098 8.293,19.707 C7.902,19.317 7.902,18.684 8.293,18.293 L14.586,12 L8.293,5.707 C7.902,5.317 7.902,4.684 8.293,4.293 Z</PathGeometry>
        <PathGeometry x:Key="CurveEditor.DirectoryBrowser.ChevronDownGeometry">M4.293,8.293 C4.684,7.902 5.317,7.902 5.707,8.293 L12,14.586 L18.293,8.293 C18.684,7.902 19.317,7.902 19.707,8.293 C20.098,8.684 20.098,9.317 19.707,9.707 L12.707,16.707 C12.317,17.098 11.684,17.098 11.293,16.707 L4.293,9.707 C3.902,9.317 3.902,8.684 4.293,8.293 Z</PathGeometry>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*" Margin="8" RowSpacing="6">
        <!-- Explorer header: root path + refresh -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="6">
            <TextBlock Grid.Column="0"
                       Text="{Binding RootDirectoryDisplayName}"
                       TextWrapping="NoWrap"
                       TextTrimming="CharacterEllipsis"
                       VerticalAlignment="Center"
                       FontFamily="{DynamicResource CurveEditor.Fonts.Monospace}"
                       ToolTip.Tip="{Binding RootDirectoryPath}"/>

            <Button Grid.Column="1"
                    Content="â†»"
                    ToolTip.Tip="Refresh Explorer"
                    Command="{Binding RefreshCommand}"
                    IsEnabled="{Binding RootDirectoryPath, Converter={x:Static ObjectConverters.IsNotNull}}"
                    Padding="6,2"/>
        </Grid>

        <!-- Explorer tree placeholder (bound, can be empty in PR2) -->
        <TreeView Grid.Row="1"
                  x:Name="ExplorerTree"
                  x:CompileBindings="False"
                  ItemsSource="{Binding RootItems}"
                  SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                  FontFamily="{DynamicResource CurveEditor.Fonts.Monospace}"
                  FontSize="{Binding FontSize}">
            <TreeView.Styles>
                <Style Selector="TreeViewItem" x:DataType="vm:ExplorerNodeViewModel">
                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                </Style>

                <!-- Keep custom chevrons unhighlighted in all states (including checked/expanded). -->
                <Style Selector="TreeViewItem ToggleButton.ExplorerChevron">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="BorderBrush" Value="Transparent"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="Template">
                        <ControlTemplate>
                            <Border Background="Transparent"
                                    BorderBrush="Transparent"
                                    BorderThickness="0">
                                <ContentPresenter Content="{TemplateBinding Content}"
                                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter>
                </Style>

                <!-- Hide the built-in TreeView expander toggle. We render our own chevrons in the node template. -->
                <Style Selector="TreeViewItem ToggleButton:not(.ExplorerChevron)">
                    <Setter Property="IsVisible" Value="False"/>
                </Style>
            </TreeView.Styles>
            <TreeView.DataTemplates>
                <TreeDataTemplate DataType="vm:ExplorerNodeViewModel" ItemsSource="{Binding Children}">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="6">
                        <!-- VS Code-style chevron: shown for directories (except root), toggles IsExpanded. -->
                        <ToggleButton Grid.Column="0"
                                      Classes="ExplorerChevron"
                                      Focusable="False"
                                      IsVisible="{Binding ShowChevron}"
                                      IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                      Width="16" Height="16"
                                      Padding="0"
                                      Background="Transparent">
                            <Grid>
                                <Path Width="12"
                                      Height="12"
                                      Stretch="Uniform"
                                      Fill="{DynamicResource CurveEditor.SideBar.SectionHeader.ForegroundBrush}"
                                      Data="{DynamicResource CurveEditor.DirectoryBrowser.ChevronRightGeometry}"
                                      IsVisible="{Binding IsExpanded, Converter={StaticResource InverseBooleanConverter}}"/>
                                <Path Width="12"
                                      Height="12"
                                      Stretch="Uniform"
                                      Fill="{DynamicResource CurveEditor.SideBar.SectionHeader.ForegroundBrush}"
                                      Data="{DynamicResource CurveEditor.DirectoryBrowser.ChevronDownGeometry}"
                                      IsVisible="{Binding IsExpanded}"/>
                            </Grid>
                        </ToggleButton>

                        <TextBlock Grid.Column="1"
                                   Text="{Binding DisplayName}"
                                   TextWrapping="NoWrap"
                                   TextTrimming="CharacterEllipsis"/>
                    </Grid>
                </TreeDataTemplate>
            </TreeView.DataTemplates>
        </TreeView>
    </Grid>
</UserControl>
